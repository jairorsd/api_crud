<!DOCTYPE html>
<html lang="pt-BR">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Produtos</title>
    <link rel="stylesheet" href="style.css">
</head>

<body>
    <div id="container">
        <a id="cadastro" href="cadastro.html">Cadastrar novo produto</a>

        <fieldset>
            <label for="categoria">
                <input type="checkbox" id="categoria" name="categoria">
                Só Com Categoria
            </label>
            <label for="pesquisar">Pesquisar por:</label>

            <input type="radio" name="pesquisar" id="pesquisaNome" checked>
            <label for="pesquisaNome">Nome</label>
            <input type="radio" name="pesquisar" id="pesquisaId">
            <label for="pesquisaId">Id</label>

            <input id="pesquisar" type="text">
            <input id="limpar" type="button" value="Limpar">
        </fieldset>

        <table id=tabelaProdutos>
            <thead>
                <tr>
                    <th>ID</th>
                    <th>Nome</th>
                    <th>Descrição</th>
                    <th>Categoria</th>
                    <th></th>
                </tr>
            </thead>
            <tbody></tbody>
        </table>
    </div>
    <div id="mensagem"></div>
    <script>

        const buscarTodosProdutos = async () => {
            try {
                const url = "http://localhost:8000/produtos";
                const response = await fetch(url);
                const data = await response.json();

                if (data.error) {
                    mostrarMensagem(data.error);
                } else if (data.produtos) {
                    mostrarTabela();
                    limparTabela();

                    data.produtos.forEach(produto => {
                        inserirLinhaNaTabela(produto);
                    });
                }
            } catch (error) {
                console.error(error);
            }
        };

        const excluirProduto = async (id) => {
            try {
                const url = `http://localhost:8000/produtos/${id}`;
                const response = await fetch(url, { method: "DELETE" });
                const data = await response.json();

                if (data.error) {
                    mostrarMensagem(data.error);
                } else if (data.message) {
                    alert(data.message);
                }
            } catch (error) {
                console.error(error);
                throw error;
            }
        };

        const addListenerLinkExluir = async (link) => {
            link.addEventListener("click", async function (event) {
                event.preventDefault();

                const row = event.target.closest("tr");
                const id = row.cells[0].textContent;

                try {
                    await excluirProduto(id);
                    row.remove();
                } catch (error) {
                    console.error(error);
                }
            });
        };

        const buscarProdutoPeloId = async (id) => {
            if (!id) return;

            if (isNaN(parseInt(id))) {
                mostrarMensagem("ID Inválido");
                return;
            }

            try {
                const url = `http://localhost:8000/produtos/${id}`;
                const response = await fetch(url);
                const data = await response.json();

                if (data.error) {
                    mostrarMensagem(data.error);
                } else if (data.produto) {
                    mostrarTabela();
                    limparTabela();
                    inserirLinhaNaTabela(data.produto);
                }
            } catch (error) {
                console.error(error);
                throw error;
            }
        };

        const buscarProdutoPeloNome = async (nome) => {
            if (!nome) return;

            try {
                const url = `http://localhost:8000/produtos?nome=${nome}`;
                const response = await fetch(url);
                const data = await response.json();

                if (data.error) {
                    mostrarMensagem(data.error);
                } else if (data.produtos) {
                    mostrarTabela();
                    limparTabela();

                    data.produtos.forEach(produto => {
                        inserirLinhaNaTabela(produto);
                    });
                }

            } catch (error) {
                console.error(error);
                throw error;
            }
        };

        const buscarApenasProdutosComCategoria = async () => {
            try {
                const url = "http://localhost:8000/produtosComCategoria";
                const response = await fetch(url);
                const data = await response.json();

                if (data.error) {
                    mostrarMensagem(data.error);
                } else if (data.produtos) {
                    mostrarTabela();
                    limparTabela();

                    data.produtos.forEach(produto => {
                        inserirLinhaNaTabela(produto);
                    });
                }
            } catch (error) {
                console.error(error);
                throw error;
            }
        };

        document.getElementById("categoria")
            .addEventListener("change", async function () {

                if (this.checked) {
                    try {
                        await buscarApenasProdutosComCategoria();
                    } catch (error) {
                        console.error(error);
                    }
                } else {

                    try {
                        await buscarTodosProdutos();
                    } catch (error) {
                        console.error(error);
                    }
                }
            });

        document.getElementById("pesquisar")
            .addEventListener("input", async function () {
                const radio = document.getElementById("pesquisaNome");

                if (this.value === "") {
                    try {
                        await buscarTodosProdutos();
                        return;
                    } catch (error) {
                        console.error(error);
                    }
                }
                if (radio.checked) {
                    try {
                        await buscarProdutoPeloNome(this.value.trim());
                    } catch (error) {
                        console.error(error);
                    }
                } else {
                    try {
                        await buscarProdutoPeloId(this.value.trim());
                    } catch (error) {
                        console.error(error);
                    }
                }
            });

        function mostrarMensagem(msg) {
            const mensagem = document.getElementById("mensagem");
            const tabelaProdutos = document.getElementById("tabelaProdutos");

            tabelaProdutos.style.display = "none";
            mensagem.innerHTML = msg;
            mensagem.style.display = "block";
        };

        function mostrarTabela() {
            const tabelaProdutos = document.getElementById("tabelaProdutos");
            const mensagem = document.getElementById("mensagem");

            tabelaProdutos.style.display = "table";
            mensagem.innerHTML = "";
            mensagem.style.display = "none";
        };

        function limparCampoPesquisa() {
            const campoPesquisar = document.getElementById("pesquisar");
            if (!campoPesquisar.value) return;
            campoPesquisar.value = "";
            campoPesquisar.focus();
        };

        document.getElementById("limpar").addEventListener("click", function () {
            limparCampoPesquisa();
            buscarTodosProdutos();
        });

        function addListenerLinkEditar(link) {
            link.addEventListener("click", function (event) {
                event.preventDefault();

                const row = event.target.closest("tr");

                const id = row.cells[0].textContent;
                const nome = row.cells[1].textContent;
                const descricao = row.cells[2].textContent;
                const categoria = row.cells[3].textContent;

                let urlBase = `edita.html?id=${id}&nome=${nome}`;

                if (descricao) {
                    urlBase += `&descricao=${descricao}`;
                }

                if (categoria) {
                    urlBase += `&categoria=${categoria}`;
                }

                window.location.href = urlBase;

            });
        };

        function inserirLinhaNaTabela(produto) {
            const tbody = document.getElementById("tabelaProdutos").getElementsByTagName("tbody")[0];

            const row = tbody.insertRow();

            row.insertCell().textContent = produto.id;
            row.insertCell().textContent = produto.nome;
            row.insertCell().textContent = produto.descricao || "";
            row.insertCell().textContent = produto.categoria || "";

            const linkEditar = document.createElement("a");
            linkEditar.href = "#";
            linkEditar.textContent = "Editar";
            linkEditar.classList.add("link-editar");
            addListenerLinkEditar(linkEditar);

            const linkExcuir = document.createElement("a");
            linkExcuir.href = "#";
            linkExcuir.textContent = "Excluír";
            linkExcuir.classList.add("link-excluír");
            addListenerLinkExluir(linkExcuir);

            const tdLinks = row.insertCell();
            tdLinks.appendChild(linkEditar);
            tdLinks.appendChild(document.createTextNode(" | "));
            tdLinks.appendChild(linkExcuir);
        };

        function limparTabela() {
            const tbody = document.getElementById("tabelaProdutos").getElementsByTagName("tbody")[0];
            tbody.innerHTML = "";
        };

        buscarTodosProdutos();

    </script>
    </table>
</body>

</html>